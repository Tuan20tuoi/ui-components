name: Publish to npm

on:
  push:
    tags:
      - 'v*.*.*'   # vÃ­ dá»¥ v1.0.0

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org/

      - name: Install deps
        run: npm install

      - name: Build
        run: npm run build

      - name: Publish
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  notify-telegram:
    runs-on: ubuntu-latest

    needs: publish
    if: always()
    steps:
      - name: Get publish status
        id: status
        run: |
            if [ "${{ needs.publish.result }}" = "success" ]; then
              echo "status=âœ… NPM PUBLISHED SUCCESSFULLY" >> $GITHUB_OUTPUT
              echo "emoji=ðŸ“¦" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ NPM PUBLISH FAILED" >> $GITHUB_OUTPUT
             echo "emoji=ðŸ’¥" >> $GITHUB_OUTPUT
            fi

      - name: Notify Telegram
        run: |
          TIME=$(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')

          MESSAGE=$(cat <<EOF
          ${{ steps.status.outputs.emoji }} *${{ steps.status.outputs.status }}*

          ðŸ“¦ *Package:* ${{ github.repository }}
          ðŸ· *Version:* ${{ github.ref_name }}
          ðŸ‘¤ *By:* ${{ github.actor }}
          ðŸ”— *Commit:* ${{ github.sha }}

          ðŸ•’ *Time:* $TIME
          EOF
          )

          curl -X POST "https://api.telegram.org/bot${{ secrets.CF_TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.CF_TELEGRAM_CHAT_ID }}\",
            \"message_thread_id\": \"${{ secrets.CF_MESSAGE_THREAD_ID }}\",
            \"text\": $(echo \"$MESSAGE\" | jq -Rs .),
            \"parse_mode\": \"Markdown\"
          }"
